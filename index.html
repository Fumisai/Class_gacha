<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>クラスガチャ（CSV対応・日本語UI・React）</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React / ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
      /* ==== あなたの JSX コードを統合 ==== */
      /* ポイント:
         1. `export default function App()` → `function App()`
         2. import 文は不要（React/ReactDOMはCDNで読み込み済み）
      */



// -----------------------------
// ユーティリティ

function csvParse(text) {
  const sep = text.includes("\t") && !text.includes(",") ? "\t" : ",";
  const rows = [];
  let i = 0, field = "", inQuotes = false, row = [];
  const pushField = () => { row.push(field); field = ""; };
  const pushRow = () => { rows.push(row); row = []; };
  while (i < text.length) {
    const c = text[i];
    if (inQuotes) {
      if (c === '"') {
        if (text[i + 1] === '"') { field += '"'; i += 2; continue; }
        inQuotes = false; i++; continue;
      }
      field += c; i++; continue;
    } else {
      if (c === '"') { inQuotes = true; i++; continue; }
      if (c === sep) { pushField(); i++; continue; }
      if (c === '\n') { pushField(); pushRow(); i++; continue; }
      if (c === '\r') {
        if (text[i + 1] === '\n') { pushField(); pushRow(); i += 2; continue; }
        pushField(); pushRow(); i++; continue;
      }
      field += c; i++; continue;
    }
  }
  if (field.length > 0 || row.length > 0) { pushField(); pushRow(); }
  return rows.filter(r => r.some(c => String(c).trim() !== ""));
}

function toNumberSafe(v) {
  if (v == null) return NaN;
  const s = String(v).trim().replace(/％|‰|%/g, "");
  const n = Number(s);
  return Number.isFinite(n) ? n : NaN;
}

function randomInRange(min, max) { return min + Math.random() * (max - min); }
function format1(x) { return (Math.round(x * 10) / 10).toFixed(1); }

function rohrerIndex(heightCm, weightKg) {
  return (weightKg / Math.pow(heightCm, 3)) * 1e7;
}

function rarityFromCellDisplay(cellDisplay) {
  if (cellDisplay === "-") return "";
  if (cellDisplay === "0.0") return "★★★";
  const n = toNumberSafe(cellDisplay);
  if (!Number.isFinite(n)) return "";
  if (n >= 0.7) return "";
  if (n >= 0.2 && n <= 0.6) return "★";
  if (n === 0.1) return "★★";
  if (n < 0.1) return "★★★";
  return "";
}

function computeZeroDotZeroWeight(knownSumPerMille, zeroDotZeroCount) {
  if (!Number.isFinite(knownSumPerMille) || knownSumPerMille < 0) knownSumPerMille = 0;
  if (!Number.isFinite(zeroDotZeroCount) || zeroDotZeroCount <= 0) return 0;
  const theoretical = 1000;
  const remainder = Math.max(0, theoretical - knownSumPerMille);
  const even = remainder / zeroDotZeroCount;
  const per = Math.max(0.01, even);
  return per;
}

function clampClassroomCount(n) {
  const num = Math.floor(Number(n) || 0);
  return Math.min(40, Math.max(1, num));
}

const FEMALE_NAMES = ["葵","茜","明日香","彩","綾","あかね","あすか","あや","歩美","文","咲","桜","さくら","早苗","さなえ","沙耶","汐里","志穂","静香","しずか","渚","七海","奈々","なな","夏希","夏美","直子","奈緒子","なおこ","菜月","菜々子","成美","のぞみ","遥","はるか","春菜","陽菜","ひな","日菜子","日向","ひより","ひかり","光","美咲","美月","美穂","美和","瑞希","みずき","みどり","みなみ","南香","実花","実里","美琴","美羽","美雨","芽衣","めい","桃","百花","百合","ゆり","優","優衣","優花","夕菜","結衣","結","結愛","ゆあ","由衣","唯","唯奈","由佳","由香","由美","友香","友里","友美","梨花","凛","りん","鈴","涼","涼子","りょう","玲","怜","麗","れい","怜奈","澪","みお","美緒","萌","萌花","桃子","麻衣","舞","真央","真奈","真菜美","真由","真理","万里","万由","真琴","真希","真弓","栞","しおり","志保","詩織","聖","聖奈","清美","清香","佳奈","佳苗","香苗","香織","かおり","香澄","かすみ","楓","かえで","花","花音","華","華子","葉月","遥香","晴香","陽子","陽未","陽向","小春","心愛","心音","心美","小百合","紗季","紗耶香","紗月","さつき","沙羅","白雪","千夏","千尋","千鶴","智子","智美","智香","知里","知美","知佳","弥生","弓香","由宇","有栖","ありす","亜衣","愛","あい","愛花","愛美","藍","藍子","亜美","彩乃","彩花","彩香","彩芽","杏","あん","杏奈","杏子","杏里","遙","里奈","りな","莉子","りこ","莉央","りりか","莉緒","梨央","梨緒","璃子","瑠璃","瑛美","映美","絵里","恵","恵美","英里","直美","直実","奈緒","夏海","望","ののか","穂香","ほのか","穂乃果","澄玲","朱里","朱音"];
const MALE_NAMES = [
  // 農民・庶民風（素朴な名）
  "太郎", "次郎", "三郎", "四郎", "五郎",
  "六蔵", "七之助", "八兵衛", "九市", "十吉",
  "与作", "庄吉", "熊吉", "源吉", "寅松",
  "亀蔵", "竹蔵", "梅吉", "松之助", "新吉",

  // 職人・町人風
  "清吉", "政吉", "徳松", "辰五郎", "長蔵",
  "喜八", "弥助", "与平", "伊之助", "甚兵衛",
  "宗吉", "佐吉", "治郎吉", "善蔵", "兼吉",

  // 士族・武士風
  "勝之進", "直之助", "義太郎", "武之丞", "忠之介",
  "源之助", "正之進", "宗太郎", "秀之助", "兼之丞",
  "久之助", "弥之進", "栄太郎", "英之介", "隆太郎",

  // 華族・上級武士風（格調ある漢字を多用）
  "篤之助", "慶之丞", "彰之進", "輝太郎", "勲之介",
  "隆之進", "栄一郎", "錦之助", "浩太郎", "馨之丞",
  "顕之進", "昌之介", "恒太郎", "英太郎", "榮之丞"
];

const SAMPLE_CSV = `身長×体重,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40
97,-,-,0.1,0.2,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-
98,-,-,0.1,-,-,-,0.1,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-
99,-,-,0.1,-,0.1,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-
100,-,0.1,0.0,0.1,0.1,-,0.0,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-
101,-,0.0,-,-,0.0,0.0,0.0,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-
102,-,-,0.7,0.5,0.4,0.4,-,0.0,0.0,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-
103,-,-,0.3,0.8,0.5,0.5,0.2,0.1,0.2,0.1,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-
104,-,0.1,0.2,1.0,1.3,0.8,0.8,0.2,0.0,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-
105,-,-,0.6,1.4,1.8,2.1,1.1,0.2,0.0,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-
106,-,-,0.4,0.9,3.0,2.5,2.4,0.7,0.5,0.0,-,0.1,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-
107,-,-,0.4,0.8,3.7,4.4,4.1,1.6,0.8,0.1,0.1,0.0,-,-,-,0.1,-,-,-,-,-,-,-,-,-,-,-,-,-
108,-,-,0.1,1.0,3.5,5.8,5.4,3.8,1.6,0.5,0.1,0.1,-,0.0,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-
109,-,-,0.1,0.7,4.0,9.7,8.5,6.0,3.4,1.2,0.3,0.4,-,0.2,0.0,-,-,-,-,-,-,-,-,-,-,-,-,-,-
110,-,-,0.0,0.4,3.2,10.3,11.1,9.3,5.7,1.7,0.9,0.3,0.2,-,-,0.3,-,-,-,-,-,-,-,-,-,-,-,-,-
111,-,-,-,0.2,2.2,8.2,14.8,13.0,7.6,3.2,1.4,0.5,0.3,0.2,0.1,0.0,0.0,-,-,-,0.0,-,-,-,-,-,-,-,-
112,-,-,-,0.1,1.9,7.0,13.0,14.7,11.9,6.1,2.2,1.2,0.9,0.1,0.1,0.0,0.1,0.1,-,-,-,-,-,-,-,-,-,-,-
113,-,-,-,0.1,0.9,4.6,13.3,18.6,15.2,10.7,4.3,2.4,1.6,0.4,0.3,0.1,0.1,0.2,0.0,-,0.0,-,-,-,-,-,-,-,-
114,-,-,-,0.0,0.7,3.5,10.5,18.7,16.3,12.5,8.9,3.0,1.3,0.6,0.4,0.1,0.1,0.2,0.1,-,-,0.0,-,-,-,-,-,-,-
115,-,-,0.0,0.0,0.3,1.8,7.9,17.2,19.4,15.7,10.1,3.3,2.2,1.4,1.0,0.8,0.2,0.1,0.1,0.1,-,0.0,-,-,-,-,-,-,-
116,-,-,-,-,0.1,1.0,5.4,13.9,17.7,18.1,10.8,6.9,3.8,1.0,1.4,0.3,0.5,0.1,0.1,0.0,-,-,-,-,-,-,-,-,-
117,-,-,-,-,0.0,0.9,4.1,9.6,13.7,16.5,10.9,8.1,5.1,2.3,1.1,0.7,0.6,0.2,0.2,0.0,-,-,-,-,-,-,-,-,-
118,-,-,-,-,0.1,0.5,1.5,8.0,11.8,13.4,13.1,9.1,5.0,2.7,1.5,0.8,0.5,0.6,0.2,-,0.2,0.1,0.0,-,-,-,-,0.0,-
119,-,-,-,-,-,0.3,0.8,3.4,10.3,12.7,12.1,9.2,7.1,5.2,1.8,1.6,0.6,0.5,0.4,0.1,0.1,0.2,0.0,-,-,-,-,-,0.1
120,-,-,-,-,0.0,0.1,0.1,2.2,6.9,9.8,11.1,8.7,6.9,3.6,2.7,2.0,0.9,0.8,0.5,0.1,0.4,0.4,0.2,-,-,-,-,-,-
121,-,-,-,-,-,0.0,0.0,1.1,3.4,5.0,6.6,7.1,5.3,3.7,2.3,2.3,0.9,0.7,0.8,0.5,0.4,0.5,0.1,0.2,-,-,-,-,0.0
122,-,-,-,-,-,0.0,0.1,0.5,1.4,4.5,5.9,6.6,5.5,5.1,2.9,1.8,0.9,0.8,0.6,0.4,0.2,0.2,0.1,0.1,0.0,0.0,-,-,0.0
123,-,-,-,-,-,0.0,0.0,0.3,0.7,2.3,3.9,5.1,4.6,3.5,2.6,1.5,1.2,0.3,0.4,0.4,0.2,0.2,0.2,0.0,0.0,-,-,-,0.1
124,-,-,-,-,-,-,-,0.4,0.4,1.3,3.0,2.7,2.3,2.9,2.3,1.3,1.0,0.7,0.5,0.2,0.3,0.1,0.1,0.1,-,-,-,0.0,0.0
125,-,-,-,-,-,-,0.0,0.2,0.3,0.7,1.4,1.7,1.6,1.8,1.8,1.3,1.0,0.6,0.2,0.4,0.2,0.1,0.4,0.2,0.0,0.1,-,-,-
126,-,-,-,-,-,-,-,-,-,0.1,0.2,0.9,1.5,0.9,1.5,0.9,0.9,0.2,0.4,0.5,0.1,0.2,0.1,0.1,0.0,0.0,0.0,0.0,0.0
127,-,-,-,-,-,-,-,-,0.1,0.1,0.4,0.1,0.6,0.6,0.6,0.7,0.8,0.6,0.3,0.5,0.4,0.4,0.1,0.0,0.1,0.0,0.1,-,-
128,-,-,-,-,-,-,-,-,-,-,0.1,0.4,0.2,0.6,0.7,0.3,0.4,0.1,0.4,0.1,0.1,0.1,-,0.0,0.1,0.1,-,0.1,0.1
129,-,-,-,-,-,-,-,-,0.0,-,0.1,0.1,0.2,0.1,0.2,0.2,0.6,0.3,0.0,0.0,0.1,0.1,0.2,0.2,0.0,0.1,0.1,-,0.0
130,-,-,-,-,-,-,-,-,-,-,0.0,0.0,0.1,0.2,0.1,0.0,0.2,0.1,0.2,0.2,0.2,0.2,-,-,-,-,0.0,-,0.1
131,-,-,-,-,-,-,-,-,-,-,-,-,-,0.1,0.1,0.0,-,0.1,0.1,0.1,0.2,0.1,0.1,0.1,-,-,-,-,-
132,-,-,-,-,-,-,-,-,-,-,-,0.5,-,-,0.1,-,-,-,0.0,-,0.0,-,0.1,-,-,-,0.0,0.0,0.0
133,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,0.0,-,-,-,-,-,-,-,0.0,-,-,-,0.1,-
134,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,0.0,0.0,0.1,-,0.0,-,-,-,-
135,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,0.0 `;

// -----------------------------
// 統計用ユーティリティ関数
function mean(arr) {
  return arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : NaN;
}

function median(arr) {
  if (arr.length === 0) return NaN;
  const sorted = [...arr].sort((a, b) => a - b);
  const mid = Math.floor(sorted.length / 2);
  return sorted.length % 2 === 0
    ? (sorted[mid - 1] + sorted[mid]) / 2
    : sorted[mid];
}

function stddev(arr) {
  if (arr.length === 0) return NaN;
  const m = mean(arr);
  const variance = mean(arr.map(x => (x - m) ** 2));
  return Math.sqrt(variance);
}


      function pickOneFromTable(tbl, gender, usedNames) {
  if (!tbl || !tbl.cells) return null;

  // weightedItems を生成
  const items = [];
  for (let ri = 0; ri < tbl.heights.length; ri++) {
    for (let ci = 0; ci < tbl.weights.length; ci++) {
      const cell = tbl.cells[ri][ci];
      const disp = cell.display;
      if (disp === "-" || disp === "") continue;
      const n = toNumberSafe(disp);
      if (Number.isFinite(n) && n > 0) {
        items.push({ rIndex: ri, cIndex: ci, weightPerMille: n, displayValue: disp });
      }
    }
  }
  if (items.length === 0) return null;

  const threshold = Math.random() * items.reduce((a, b) => a + b.weightPerMille, 0);
  let acc = 0;
  let chosen = items[0];
  for (const item of items) {
    acc += item.weightPerMille;
    if (threshold <= acc) { chosen = item; break; }
  }

  const heightClass = tbl.heights[chosen.rIndex];
  const weightClass = tbl.weights[chosen.cIndex];

  const h = Number(format1(randomInRange(heightClass - 0.9, heightClass)));
  const w = Number(format1(randomInRange(weightClass - 0.9, weightClass)));

  const rohrer = rohrerIndex(h, w);
  const nameList = gender === "male" ? MALE_NAMES : FEMALE_NAMES;
  const name = nameList[Math.floor(Math.random() * nameList.length)];

  return {
    name, height: h, weight: w,
    rohrer: Number(format1(rohrer)),
    rarity: rarityFromCellDisplay(chosen.displayValue),
    gender
  };
}

      

// -----------------------------
// メインアプリ
// -----------------------------
function App() {
  const [rawCsv, setRawCsv] = React.useState("");
  const [table, setTable] = React.useState(null);
  const [message, setMessage] = React.useState("");
  const [results, setResults] = React.useState([]);
  const [sortKey, setSortKey] = React.useState("");
  const [sortOrder, setSortOrder] = React.useState("desc");
  const [manualName, setManualName] = React.useState("");
  const [manualHeight, setManualHeight] = React.useState("");
  const [manualWeight, setManualWeight] = React.useState("");
  const [manualHistory, setManualHistory] = React.useState([]);
  const [selectedHistoryIds, setSelectedHistoryIds] = React.useState([]);
  const [classroomCount, setClassroomCount] = React.useState(16);
  const [presetPath, setPresetPath] = React.useState("");
  const [manifest, setManifest] = React.useState({});
  const [yearKey, setYearKey] = React.useState("");
  const [source, setSource] = React.useState("");
  const [femaleRatio, setFemaleRatio] = React.useState(50); // 初期値 50%: 男女半々

 // ページ読込時に manifest.json を取得
  React.useEffect(() => {
  (async () => {
    try {
      const res = await fetch("./folder/manifest.json", { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();
      setManifest(json || {});
    } catch (e) {
      setMessage(`マニフェスト読込エラー: ${e.message || e}`);
    }
  })();
  }, []);

 // セレクト用の選択肢
  const yearOptions = React.useMemo(
  () => Object.keys(manifest).sort(),
  [manifest]
);
  const fileOptions = React.useMemo(
    () => (yearKey ? manifest[yearKey] || [] : []),
    [manifest, yearKey]
  );


  async function handleLoadPreset() {
    if (!presetPath) return;
    try {
      const res = await fetch(presetPath);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const text = await res.text();
      setRawCsv(text);
      ingestCsv(text);
    } catch (e) {
      setMessage(`プリセット読込エラー: ${e.message || e}`);
    }
  }
  const fileRef = React.useRef(null);

  React.useEffect(() => { runInternalTests(); }, []);



  async function handleLoad() {
  try {
    if (source === "sample") {
      ingestCsv(SAMPLE_CSV);
      setMessage("サンプルCSVを読み込みました。");
    } else if (source === "upload") {
      if (!fileRef.current?.files?.[0]) {
        setMessage("CSVファイルを選択してください。");
      } else {
        setMessage("アップロードCSVを選択しました。");
      }
    } else {
  const srcObj = JSON.parse(source); // { label, female, male }
  const [femaleRes, maleRes] = await Promise.all([
    fetch(srcObj.female.path),
    fetch(srcObj.male.path)
  ]);
  if (!femaleRes.ok || !maleRes.ok) throw new Error("CSV取得失敗");

  const [femaleCsv, maleCsv] = await Promise.all([
    femaleRes.text(),
    maleRes.text()
  ]);

  const femaleTable = ingestCsv(femaleCsv, "female", { returnOnly: true });
  const maleTable   = ingestCsv(maleCsv, "male", { returnOnly: true });

  setTable({ female: femaleTable, male: maleTable });
  setResults([]);
  setMessage(`${srcObj.label} の男女CSVを読み込みました。`);
}


  } catch (e) {
    setMessage(`読込エラー: ${e.message}`);
  }
}


  
  
  const meta = React.useMemo(() => {
    if (!table) return null;
    let knownSum = 0;
    let zeroDotZeroCount = 0;
    for (let r = 0; r < table.cells.length; r++) {
      for (let c = 0; c < table.cells[r].length; c++) {
        const disp = table.cells[r][c].display;
        if (disp === "-") continue;
        if (disp === "0.0") { zeroDotZeroCount++; continue; }
        const val = toNumberSafe(disp);
        if (Number.isFinite(val)) knownSum += val;
      }
    }
    const perZeroDotZero = computeZeroDotZeroWeight(knownSum, zeroDotZeroCount);
    const sumIfAssigned = knownSum + perZeroDotZero * zeroDotZeroCount;
    return { knownSum, zeroDotZeroCount, perZeroDotZero, sumIfAssigned };
  }, [table]);

  const weightedItems = React.useMemo(() => {
    if (!table || !meta) return [];
    const items = [];
    for (let ri = 0; ri < table.heights.length; ri++) {
      for (let ci = 0; ci < table.weights.length; ci++) {
        const cell = table.cells[ri][ci];
        const disp = cell.display;
        if (disp === "-") continue;
        let w;
        if (disp === "0.0") {
          w = meta.perZeroDotZero;
        } else {
          const n = toNumberSafe(disp);
          if (!Number.isFinite(n) || n <= 0) continue;
          w = n;
        }
        if (w > 0) {
          items.push({
            rIndex: ri, cIndex: ci,
            weightPerMille: w,
            displayValue: disp
          });
        }
      }
    }
    return items;
  }, [table, meta]);

  const totalWeight = React.useMemo(() => weightedItems.reduce((a, b) => a + b.weightPerMille, 0), [weightedItems]);

  const displayedResults = React.useMemo(() => {
    const withIndex = results.map((r, i) => ({ ...r, _genIndex: i }));
    if (!sortKey) return withIndex;
    const getter = (x) => sortKey === 'height' ? x.height : (sortKey === 'weight' ? x.weight : x.rohrer);
    return [...withIndex].sort((a, b) => {
      const va = getter(a), vb = getter(b);
      return sortOrder === 'desc' ? vb - va : va - vb;
    });
  }, [results, sortKey, sortOrder]);

function renderRarityBadge(rarity) {
    if (!rarity) return <span className="text-slate-400">—</span>;
    const color =
      rarity === "★"   ? "text-amber-600" :
      rarity === "★★"  ? "text-rose-600"  :
      rarity === "★★★" ? "text-indigo-600" :
                        "text-slate-700";
    return (
      <span
      className={`font-semibold ${color}`}
      title={`レア度 ${rarity}`}
      aria-label={`レア度 ${rarity.length} つ`}
      >
        {rarity}
      </span>
    );
  }
  
  // 体格判定関数
  function rohrerCategoryColor(rohrer) {
  if (rohrer < 100) return "text-sky-600 font-semibold";      // かなりやせ
  if (rohrer < 115) return "text-teal-600 font-semibold";     // やせ
  if (rohrer < 145) return "";  // 標準
  if (rohrer < 160) return "text-amber-600 font-semibold";    // ややふとり
  return "text-rose-600 font-semibold";                       // ふとり
}
  
  function pickOne() {
    if (!table) { setMessage("CSVを読み込んでください。"); return null; }
    if (weightedItems.length === 0) { setMessage("抽選可能なセルがありません。"); return null; }

    // 重みは‰だが、相対値としてそのまま使う
    const threshold = Math.random() * totalWeight;
    let acc = 0;
    let chosen = weightedItems[0];
    for (const item of weightedItems) {
      acc += item.weightPerMille;
      if (threshold <= acc) { chosen = item; break; }
    }

    const heightClass = table.heights[chosen.rIndex];
    const weightClass = table.weights[chosen.cIndex];

    const hMin = heightClass - 0.9, hMax = heightClass; // [x.1, x.0]
    const wMin = weightClass - 0.9, wMax = weightClass;
    const height = Number(format1(randomInRange(hMin, hMax)));
    const weight = Number(format1(randomInRange(wMin, wMax)));

    const rohrer = rohrerIndex(height, weight);
    const rarity = rarityFromCellDisplay(chosen.displayValue);
    const nameList = table.gender === "male" ? MALE_NAMES : FEMALE_NAMES;
    const name = nameList[Math.floor(Math.random() * nameList.length)];


    
    return {
      name,
      height,
      weight,
      rohrer: Number(format1(rohrer)),
      rarity,
      heightClass,
      weightClass,
      cellDisplay: chosen.displayValue
    };
  }

function runGacha(times) {
  if (!table?.female || !table?.male) {
    setMessage("男女両方のCSVを読み込んでください。");
    return;
  }

  const femaleCount = Math.round(times * femaleRatio / 100);
  const maleCount   = times - femaleCount;

  const tmp = [];
  const usedNames = new Set();

  for (let i = 0; i < femaleCount; i++) {
    let one = null, safety = 0;
    while (safety < 50) {
      one = pickOneFromTable(table.female, "female", usedNames);
      if (one && !usedNames.has(one.name)) break;
      safety++;
    }
    if (one) { tmp.push(one); usedNames.add(one.name); }
  }

  for (let i = 0; i < maleCount; i++) {
    let one = null, safety = 0;
    while (safety < 50) {
      one = pickOneFromTable(table.male, "male", usedNames);
      if (one && !usedNames.has(one.name)) break;
      safety++;
    }
    if (one) { tmp.push(one); usedNames.add(one.name); }
  }

  if (tmp.length > 0) setResults(tmp);
}




  // 指定の値が属するクラスのインデックスを返す（[x-0.9, x]）
  function findClassIndex(values, v) {
    if (!Array.isArray(values)) return -1;
    for (let i = 0; i < values.length; i++) {
      const cls = values[i];
      if (v >= cls - 0.9 - 1e-9 && v <= cls + 1e-9) return i;
    }
    return -1;
  }

  // 手入力データを結果に追加
  function addManualEntry() {
    if (!table) { setMessage("CSVを読み込んでください。"); return; }
    const h = Number(manualHeight);
    const w = Number(manualWeight);
    if (!Number.isFinite(h) || !Number.isFinite(w)) { setMessage("身長・体重は数値で入力してください。"); return; }
    if (h <= 0 || w <= 0) { setMessage("身長・体重は正の数で入力してください。"); return; }

    const ri = findClassIndex(table.heights, h);
    const ci = findClassIndex(table.weights, w);

    let cellDisplay = "-";
    let rarity = "";
    if (ri >= 0 && ci >= 0) {
      const disp = table.cells[ri][ci]?.display ?? "-";
      cellDisplay = disp;
      rarity = rarityFromCellDisplay(disp);
    }

    const name = manualName?.trim() || "手入力";
    const rohrer = Number(format1(rohrerIndex(h, w)));

    const entry = {
      _id: Date.now() + ":" + Math.random().toString(36).slice(2, 8),
      name,
      height: Number(format1(h)),
      weight: Number(format1(w)),
      rohrer,
      rarity,
      heightClass: ri >= 0 ? table.heights[ri] : undefined,
      weightClass: ci >= 0 ? table.weights[ci] : undefined,
      cellDisplay
    };

    setResults(prev => [...prev, entry]);
    setManualHistory(prev => [entry, ...prev]); // 履歴は新しい順で先頭

    setMessage("手入力データを追加しました。");
  }

  function addSelectedHistoryToResults() {
    if (selectedHistoryIds.length === 0) { setMessage("履歴が選択されていません。"); return; }
    const selected = manualHistory.filter(r => selectedHistoryIds.includes(r._id));
    if (selected.length === 0) { setMessage("有効な選択がありません。"); return; }
    setResults(prev => [...prev, ...selected]);
    setMessage(`${selected.length} 件の履歴を結果に追加しました。`);
    setSelectedHistoryIds([]);
  }

  function toggleHistorySelection(id) {
    setSelectedHistoryIds(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
  }

  function clearSelectedHistory() {
    if (selectedHistoryIds.length === 0) {
      setMessage("履歴が選択されていません。");
      return;
    }
    setManualHistory(prev => prev.filter(r => !selectedHistoryIds.includes(r._id)));
    setSelectedHistoryIds([]);
    setMessage("選択した履歴をクリアしました。");
  }

  function handleLoadSample() {
    setRawCsv(SAMPLE_CSV);
    ingestCsv(SAMPLE_CSV);
  }

  function handleFile(e) {
    const f = e.target.files?.[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      const text = String(reader.result || "");
      setRawCsv(text);
      ingestCsv(text);
    };
    reader.readAsText(f);
  }

  function ingestCsv(text, gender="female", opts={}) {
  try {
    const rows = csvParse(text);
      if (rows.length < 2) throw new Error("ヘッダー行＋データ行が必要です");

      // 1行目: ウェイト（体重）ヘッダー
      const header = rows[0];
      // 先頭セルはラベル、以降が体重クラス
      const weightLabels = header.slice(1).map(toNumberSafe).filter(Number.isFinite);
      if (weightLabels.length === 0) throw new Error("体重のヘッダーがありません");

      const heights = [];
      const cells = [];
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        if (row.length === 0) continue;
        const h = toNumberSafe(row[0]);
        if (!Number.isFinite(h)) continue; // ラベル行などはスキップ
        heights.push(h);
        const rowCells = [];
        for (let j = 1; j < row.length; j++) {
          const raw = String(row[j]).trim();
          // 許容: 数値(例: "0.3"), "0.0", "-"
          if (raw === "-") { rowCells.push({ display: "-" }); continue; }
          if (raw === "0.0") { rowCells.push({ display: "0.0" }); continue; }
          const n = toNumberSafe(raw);
          if (Number.isFinite(n)) {
            const disp = n <= 0 ? "-" : String(n);
            rowCells.push({ display: disp });
          } else {
            rowCells.push({ display: "-" });
          }
        }
        while (rowCells.length < weightLabels.length) rowCells.push({ display: "-" });
        rowCells.length = weightLabels.length;
        cells.push(rowCells);
      }

      const parsed = { heights, weights: weightLabels, cells, gender };

if (opts.returnOnly) {
  return parsed;   // 呼び出し元に返す
}

setTable(parsed);
setResults([]);
setMessage("CSVを読み込みました。");

  } catch (err) {
    if (opts.returnOnly) throw err; // 呼び出し元にエラーを投げる
    setMessage(`CSV読込エラー: ${err.message || err}`);
    setTable(null);
    setResults([]);
    }
  }

  function clearResults() { setResults([]); }
  
    const stats = React.useMemo(() => {
    if (displayedResults.length === 0) return null;
    const heights = displayedResults.map(r => r.height);
    const weights = displayedResults.map(r => r.weight);
    const rohrers = displayedResults.map(r => r.rohrer);

    return {
      height: {
        mean: mean(heights),
        median: median(heights),
        stddev: stddev(heights),
      },
      weight: {
        mean: mean(weights),
        median: median(weights),
        stddev: stddev(weights),
      },
      rohrer: {
        mean: mean(rohrers),
        median: median(rohrers),
        stddev: stddev(rohrers),
      }
    };
  }, [displayedResults]);

  
  
  function openGoogleFor(hw) {
  // hw: { height: number, weight: number, name?: string }
  const h = Number(hw.height);
  const w = Number(hw.weight);
  if (!Number.isFinite(h) || !Number.isFinite(w)) {
    setMessage("検索できる数値がありません。");
    return;
  }
  // 四捨五入して整数に
  const query = `${Math.round(h)}cm ${Math.round(w)}kg`;
  const url = `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(query)}`;
  window.open(url, "_blank", "noopener,noreferrer");
}


  return (
    <div className="min-h-screen bg-slate-50 text-slate-900">
      <header className="sticky top-0 z-10 bg-white/90 backdrop-blur border-b">
        <div className="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
          <div className="text-2xl font-bold">クラスガチャ</div>
          <div className="text-xs text-slate-500">（CSV対応・ローレル指数自動計算・日本語UI）</div>
        </div>
      </header>

      <main className="max-w-6xl mx-auto p-4 space-y-6">
        {/* データの読み込み */}

        <section className="bg-white rounded-2xl shadow p-4 space-y-4">
  <h2 className="text-lg font-semibold">データの読み込み</h2>
  <div className="flex flex-col sm:flex-row gap-3 items-start sm:items-center">

    {/* ソース選択 */}
    <select
      className="border rounded-xl px-3 py-2 text-sm bg-white"
      value={source}
      onChange={(e) => setSource(e.target.value)}
    >
      <option value="">データソースを選択</option>
      <option value="upload">ファイルをアップロード</option>
      <option value="sample">サンプルCSV</option>
      {Object.keys(manifest).map(y => (
  <optgroup key={y} label={`${y}年度`}>
    {(manifest[y] || []).map((f, i) => (
      <option key={i} value={JSON.stringify(f)}>
        {f.label}（男女ペア）
      </option>
    ))}
  </optgroup>
))}


    </select>

    {/* 読み込みボタン */}
    <button
      className="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 text-sm"
      onClick={handleLoad}
      type="button"
      disabled={!source}
    >
      読み込む
    </button>
  </div>

  {/* ファイルアップロード UI は選択時だけ表示 */}
  {source === "upload" && (
    <input
      ref={fileRef}
      type="file"
      accept=".csv,text/csv"
      onChange={handleFile}
      className="block w-full text-sm mt-2"
    />
  )}

  {message && (
    <div className="text-sm text-slate-700 bg-slate-100 rounded-xl px-3 py-2 inline-block mt-2">
      {message}
    </div>
  )}

          <details className="text-sm text-slate-600">
            <summary className="cursor-pointer select-none py-1">CSVフォーマットの説明（クリックで開く）</summary>
            <div className="mt-2 space-y-2">
              <p>・1行目は体重クラスのヘッダー。先頭セルはラベル、以降が <code>35,40,45</code> のような数値。</p>
              <p>・2行目以降は、先頭セルに身長クラス（例：<code>140</code>）を記載。続くセルは各セルの頻度（‰）。</p>
              <p>・値は <code>0.1</code> や <code>0.6</code> のような数値、<code>0.0</code>、または <code>-</code>（ゼロ）を使用できます。</p>
              <p>・<code>0.0</code> は 0 &lt; 頻度 &lt; 0.1‰ を表します。抽選用の重みは理論合計(1000‰)との差分を <strong>0.0 セルで均等配分</strong>し、さらに <strong>各0.0セルに最低 0.01‰</strong> を保証します。</p>
              <p>・クラス幅の解釈：<code>140</code> → [139.1cm, 140.0cm]、<code>35</code> → [34.1kg, 35.0kg]</p>
            </div>
          </details>

          {message && (
            <div className="text-sm text-slate-700 bg-slate-100 rounded-xl px-3 py-2 inline-block">{message}</div>
          )}

          {table && (
            <div className="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
              <div className="bg-slate-50 rounded-2xl p-3 border">
                <div className="text-slate-500">行（身長クラス）</div>
                <div className="text-xl font-semibold">{table.heights.length} 行</div>
              </div>
              <div className="bg-slate-50 rounded-2xl p-3 border">
                <div className="text-slate-500">列（体重クラス）</div>
                <div className="text-xl font-semibold">{table.weights.length} 列</div>
              </div>
              <div className="bg-slate-50 rounded-2xl p-3 border">
                <div className="text-slate-500">抽選用 合計‰</div>
                <div className="text-xl font-semibold">{format1(totalWeight)}</div>
                {meta && (
                  <div className="text-xs text-slate-500 mt-1">
                    既知合計: {format1(meta.knownSum)}‰ / 0.0セル: {meta.zeroDotZeroCount} / 0.0配分: {format1(meta.perZeroDotZero)}‰/セル
                    {meta.sumIfAssigned > 1000 && (
                      <span className="ml-2 inline-block px-2 py-0.5 rounded bg-amber-100 text-amber-800">合計が1000‰を超過（最低0.01‰保証のため）</span>
                    )}
                  </div>
                )}
              </div>
            </div>
          )}
        </section>

        {/* ガチャ */}
        <section className="bg-white rounded-2xl shadow p-4 space-y-4">
          <h2 className="text-lg font-semibold">ガチャ</h2>
          <div className="flex flex-col sm:flex-row flex-wrap items-start sm:items-center gap-3 w-full">
            {/* 教室人数の選択（2〜20） */}
            <label className="flex items-center gap-2 text-sm text-slate-700 bg-slate-50 border rounded-xl px-3 py-2">
              <span>教室人数</span>
              <div className="flex items-center gap-1">
                <button
                  type="button"
                  onClick={() => setClassroomCount(c => clampClassroomCount(c - 1))}
                  className="px-2 py-1 rounded-lg bg-slate-200 hover:bg-slate-300 text-sm"
                  >−</button>
                <input
                  type="number"
                  inputMode="numeric"
                  min={1}
                  max={40}
                  value={classroomCount}
                  onChange={(e) => setClassroomCount(clampClassroomCount(e.target.value))}
                  className="w-16 border rounded-md px-2 py-1 text-center"
                  />
                <button
                  type="button"
                  onClick={() => setClassroomCount(c => clampClassroomCount(c + 1))}
                  className="px-2 py-1 rounded-lg bg-slate-200 hover:bg-slate-300 text-sm"
                  >＋</button>
                <span className="text-slate-500">人</span>
              </div>
            </label>

            
            <button
              className="px-5 py-3 rounded-2xl bg-indigo-600 text-white font-bold hover:bg-indigo-700"
              onClick={() => runGacha(clampClassroomCount(classroomCount))}
              type="button"
              disabled={!table}
              title={`${clampClassroomCount(classroomCount)}人を一括生成`}
            >教室ガチャ（{clampClassroomCount(classroomCount)}人分）</button>
            
            {/* 男女比スライダー */}
            <label className="flex flex-col gap-2 text-sm text-slate-700 bg-slate-50 border rounded-xl px-3 py-2 w-full sm:w-auto">
              <span>男女比（女子%）</span>
              <input
                type="range"
                min="0"
                max="100"
                step="1"
                value={femaleRatio}
                onChange={(e) => setFemaleRatio(Number(e.target.value))}
                className="w-full"
                />
              <div className="flex justify-between text-xs text-slate-600">
                <span>女子 {femaleRatio}%</span>
                <span>男子 {100 - femaleRatio}%</span>
              </div>
            </label>


            

          {/* 手入力で結果に追加 */}
          <div className="mt-3 grid sm:grid-cols-3 gap-3">
            <div className="col-span-3 text-slate-700 text-sm font-medium">手入力で結果に追加</div>
            <input
              type="text"
              className="border rounded-xl px-3 py-2"
              placeholder="名前（省略可: 手入力）"
              value={manualName}
              onChange={(e) => setManualName(e.target.value)}
            />
            <input
              type="number"
              min="1"
              step="0.1"
              className="border rounded-xl px-3 py-2"
              placeholder="身長 (cm) 例: 152.4"
              value={manualHeight}
              onChange={(e) => setManualHeight(e.target.value)}
            />
            <input
              type="number"
              min="1"
              step="0.1"
              className="border rounded-xl px-3 py-2"
              placeholder="体重 (kg) 例: 43.0"
              value={manualWeight}
              onChange={(e) => setManualWeight(e.target.value)}
            />
            <div className="col-span-3">
              <button
                type="button"
                className="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700"
                onClick={addManualEntry}
                disabled={!table}
                title="入力した数値で1行追加"
              >この内容を結果に追加</button>
              <div className="text-xs text-slate-500 mt-2">
                ※ 手入力した身長・体重が頻度表のクラスに該当する場合は、そのセル表示とレア度を付与します。該当しない場合はセル表示「-」／レア度なしで追加されます。
              </div>
            </div>
          </div>
          </div>

         
        </section>

        {/* 結果 */}
        <section className="bg-white rounded-2xl shadow p-0 overflow-hidden">
          <div className="px-4 py-3 border-b flex items-center justify-between gap-3 flex-wrap">
            <h2 className="text-lg font-semibold">結果</h2>
            <div className="flex items-center gap-2 text-sm">
              <label className="text-slate-600">並び替え:</label>
              <select
                className="border rounded-lg px-2 py-1 bg-white"
                value={sortKey}
                onChange={(e) => setSortKey(e.target.value)}
                title="並び替えの対象"
              >
                <option value="">生成順のまま</option>
                <option value="height">身長（cm）</option>
                <option value="weight">体重（kg）</option>
                <option value="rohrer">ローレル指数</option>
              </select>
              <select
                className="border rounded-lg px-2 py-1 bg-white"
                value={sortOrder}
                onChange={(e) => setSortOrder(e.target.value)}
                title="高い順・低い順"
                disabled={!sortKey}
              >
                <option value="desc">高い順</option>
                <option value="asc">低い順</option>
              </select>
            </div>
          </div>
           <details className="text-sm text-slate-600 px-4 py-2">
             <summary className="cursor-pointer select-none py-1">レア度の基準</summary>
             <div className="mt-2 flex flex-col gap-1">
               <span><span className="font-semibold text-amber-600">★</span> ややレア（0.2〜0.6‰）</span>
               <span><span className="font-semibold text-rose-600">★★</span> レア（0.1‰）</span>
               <span><span className="font-semibold text-indigo-600">★★★</span> 激レア（0.1‰未満）</span>
             </div>
           </details>
          <details className="text-sm text-slate-600 px-4 py-2">
            <summary className="cursor-pointer select-none py-1">体格判定の基準</summary>
            <div className="mt-2 flex flex-col gap-1">
              <span><span className="font-semibold text-sky-600">かなりやせ</span> （&lt;100）</span>
                <span><span className="font-semibold text-teal-600">やせ</span> （100〜114）</span>
                <span><span className="font-semibold text-Black-600">標準</span> （115〜144）</span>
                <span><span className="font-semibold text-amber-600">ふとり</span> （145〜159）</span>
                <span><span className="font-semibold text-rose-600">ふとりすぎ</span> （160以上）</span>
              </div>
            </details>

          <div className="overflow-x-auto">
            <table className="min-w-full text-sm">
              <thead className="bg-slate-100">
                <tr>
                  <th className="text-left px-3 py-2 font-semibold border-b">No.</th>
                  <th className="text-left px-3 py-2 font-semibold border-b">名前</th>
                  <th className="text-right px-3 py-2 font-semibold border-b">身長 (cm)</th>
                  <th className="text-right px-3 py-2 font-semibold border-b">体重 (kg)</th>
                  <th className="text-right px-3 py-2 font-semibold border-b">ローレル指数</th>
                  <th className="text-center px-3 py-2 font-semibold border-b">レア度</th>
                  <th className="text-center px-3 py-2 font-semibold border-b text-slate-500">セル表示</th>
                  <th className="text-center px-3 py-2 font-semibold border-b">検索</th>
                </tr>
              </thead>
              <tbody>
                {displayedResults.length === 0 ? (
                  <tr>
                    <td colSpan={7} className="text-center text-slate-500 py-8">
                      まだ結果がありません。CSVを読み込み、ガチャを回してください。
                    </td>
                  </tr>
                ) : (
                  displayedResults.map((r, idx) => (
                    <tr key={r._genIndex ?? r._id} className={idx % 2 === 0 ? "bg-white" : "bg-slate-50"}>
                      <td className="px-3 py-2 border-b">{idx + 1}</td>
                      <td className="px-3 py-2 border-b font-medium">{r.name}</td>
                      <td className="px-3 py-2 border-b text-right tabular-nums">{format1(r.height)}</td>
                      <td className="px-3 py-2 border-b text-right tabular-nums">{format1(r.weight)}</td>
                      <td className={`px-3 py-2 border-b text-right tabular-nums ${rohrerCategoryColor(r.rohrer)}`}>
                        {format1(r.rohrer)}
                      </td>
                      <td className="px-3 py-2 border-b text-center text-lg tracking-wide">{renderRarityBadge(r.rarity)}</td>
                      <td className="px-3 py-2 border-b text-center text-slate-500">{r.cellDisplay}</td>
                      <td className="px-3 py-2 border-b text-center">
                         <button
                           type="button"
                           className="px-3 py-1 rounded-lg bg-slate-900 text-white text-xs hover:bg-slate-700"
                           onClick={() => openGoogleFor(r)}
                           title="(身長cm 体重kg) でGoogle検索"
                           >
                           検索+     </button>
                       </td>
                    </tr>
                  ))
                )}
              </tbody>
              {stats && (
      <tfoot className="bg-slate-100 text-xs">
    <tr>
      <td className="px-3 py-2 border-t text-right font-semibold" colSpan={2}>平均</td>
      <td className="px-3 py-2 border-t text-right">{format1(stats.height.mean)}</td>
      <td className="px-3 py-2 border-t text-right">{format1(stats.weight.mean)}</td>
      <td className="px-3 py-2 border-t text-right">{format1(stats.rohrer.mean)}</td>
      <td colSpan={3} className="border-t"></td>
    </tr>
    <tr>
      <td className="px-3 py-2 border-t text-right font-semibold" colSpan={2}>中央値</td>
      <td className="px-3 py-2 border-t text-right">{format1(stats.height.median)}</td>
      <td className="px-3 py-2 border-t text-right">{format1(stats.weight.median)}</td>
      <td className="px-3 py-2 border-t text-right">{format1(stats.rohrer.median)}</td>
      <td colSpan={3} className="border-t"></td>
    </tr>
    <tr>
      <td className="px-3 py-2 border-t text-right font-semibold" colSpan={2}>標準偏差</td>
      <td className="px-3 py-2 border-t text-right">{format1(stats.height.stddev)}</td>
      <td className="px-3 py-2 border-t text-right">{format1(stats.weight.stddev)}</td>
      <td className="px-3 py-2 border-t text-right">{format1(stats.rohrer.stddev)}</td>
      <td colSpan={3} className="border-t"></td>
    </tr>
  </tfoot>
)}
            </table>
          </div>
        </section>

      

        
        {/* 手入力履歴（セッション内保持／リロードで消えます） */}
        <section className="bg-white rounded-2xl shadow p-4 space-y-3">
          <div className="flex items-center justify-between gap-3 flex-wrap">
            <h2 className="text-lg font-semibold">手入力履歴</h2>
            <div className="flex gap-2">
              <button
                className="px-3 py-2 rounded-xl bg-slate-200 hover:bg-slate-300 text-sm"
                onClick={addSelectedHistoryToResults}
                disabled={selectedHistoryIds.length === 0}
              >選択した履歴を結果に追加</button>
              <button
                className="px-3 py-2 rounded-xl bg-rose-100 hover:bg-rose-200 text-rose-700 text-sm"
                onClick={clearSelectedHistory}
                disabled={selectedHistoryIds.length === 0}
              >選択した履歴をクリア</button>
            </div>
          </div>
          {manualHistory.length === 0 ? (
            <div className="text-sm text-slate-500">履歴はまだありません。</div>
          ) : (
            <div className="overflow-x-auto">
              <table className="min-w-full text-xs">
                <thead className="bg-slate-100">
                  <tr>
                    <th className="px-2 py-1 border-b">選択</th>
                    <th className="text-left px-2 py-1 border-b">No.</th>
                    <th className="text-left px-2 py-1 border-b">名前</th>
                    <th className="text-right px-2 py-1 border-b">身長</th>
                    <th className="text-right px-2 py-1 border-b">体重</th>
                    <th className="text-right px-2 py-1 border-b">ローレル指数</th>
                    <th className="text-center px-2 py-1 border-b">セル表示</th>
                  </tr>
                </thead>
                <tbody>
                  {manualHistory.map((r, i) => (
                    <tr key={r._id} className={i % 2 === 0 ? "bg-white" : "bg-slate-50"}>
                      <td className="px-2 py-1 border-b text-center">
                        <input
                          type="checkbox"
                          checked={selectedHistoryIds.includes(r._id)}
                          onChange={() => toggleHistorySelection(r._id)}
                        />
                      </td>
                      <td className="px-2 py-1 border-b">{i + 1}</td>
                      <td className="px-2 py-1 border-b">{r.name}</td>
                      <td className="px-2 py-1 border-b text-right">{format1(r.height)}</td>
                      <td className="px-2 py-1 border-b text-right">{format1(r.weight)}</td>
                      <td className="px-2 py-1 border-b text-right">{format1(r.rohrer)}</td>
                      <td className="px-2 py-1 border-b text-center text-slate-500">{r.cellDisplay}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </section>

        {/* データプレビュー（任意） */}
        {table && (
          <section className="bg-white rounded-2xl shadow p-4 space-y-3">
            <h2 className="text-lg font-semibold">読み込んだ頻度表（‰）</h2>
            <div className="overflow-x-auto">
              <table className="text-xs border min-w-full">
                <thead>
                  <tr>
                    <th className="border px-2 py-1 bg-slate-100 text-left">身長×体重</th>
                    {table.weights.map((w, i) => (
                      <th key={i} className="border px-2 py-1 bg-slate-100 text-right">{w}</th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {table.heights.map((h, ri) => (
                    <tr key={ri}>
                      <td className="border px-2 py-1 bg-slate-50 text-right font-medium">{h}</td>
                      {table.cells[ri].map((c, ci) => (
                        <td
                          key={ci}
                          className={`border px-2 py-1 text-right tabular-nums ${c.display === '-' ? 'text-slate-400' : ''}`}
                        >
                          {c.display}
                        </td>
                      ))}
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </section>
        )}

        <section className="text-xs text-slate-500 leading-6">
          <p>・本アプリは統計的頻度表に基づくフィクション生成です。個人の実在性はありません。</p>
          <p>・ブラウザ上だけで動作し、macOS（Chrome）やXcodeの簡易Webホストでも実行可能です。</p>
        </section>
      </main>
    </div>
  );
}

// -----------------------------
// 簡易テスト（ランタイム）
// -----------------------------
function runInternalTests() {
  const results = [];
  const pass = (name) => results.push({ name, ok: true });
  const fail = (name, msg) => results.push({ name, ok: false, msg });
  const nearly = (a, b, eps = 1e-6) => Math.abs(a - b) <= eps;

  try {
    // Test 1: rohrerIndex（既知値近傍）
    const r = rohrerIndex(140.0, 40.0); // ≈ 145.79
    if (nearly(r, 145.79, 0.2)) pass("rohrerIndex basic"); else fail("rohrerIndex basic", `got ${r}`);

    // Test 2: rarity
    if (rarityFromCellDisplay('-') === "") pass("rarity '-'=blank"); else fail("rarity '-'", "");
    if (rarityFromCellDisplay('0.0') === "★★★") pass("rarity 0.0"); else fail("rarity 0.0", "");
    if (rarityFromCellDisplay('0.7') === "") pass("rarity 0.7"); else fail("rarity 0.7", "");
    if (rarityFromCellDisplay('0.2') === "★") pass("rarity 0.2"); else fail("rarity 0.2", "");
    if (rarityFromCellDisplay('0.1') === "★★") pass("rarity 0.1"); else fail("rarity 0.1", "");
    if (rarityFromCellDisplay('0.09') === "★★★") pass("rarity 0.09"); else fail("rarity 0.09", "");

    // Test 3: csvParse 基本
    const csvA = 'H,W\n140,30\n';
    const parsedA = csvParse(csvA);
    if (Array.isArray(parsedA) && parsedA.length === 2 && parsedA[1][0] === '140') pass("csvParse basic"); else fail("csvParse basic", JSON.stringify(parsedA));

    // Test 4: 並び替えロジック
    const dummy = [
      { height: 150, weight: 45, rohrer: 130 },
      { height: 140, weight: 35, rohrer: 128 },
      { height: 160, weight: 50, rohrer: 160 },
    ];
    const sortFn = (arr, key, order) => {
      const getter = (x) => key === 'height' ? x.height : (key === 'weight' ? x.weight : x.rohrer);
      return [...arr].sort((a, b) => order === 'desc' ? getter(b) - getter(a) : getter(a) - getter(b));
    };
    const byHDesc = sortFn(dummy, 'height', 'desc');
    const byHAsc = sortFn(dummy, 'height', 'asc');
    if (byHDesc[0].height === 160 && byHAsc[0].height === 140) pass("sort by height"); else fail("sort by height", JSON.stringify({ byHDesc, byHAsc }));

    // Test 5: 0.0セル最低0.01‰保証
    const per1 = computeZeroDotZeroWeight(999.5, 100); // remainder=0.5 → even=0.005 → min=0.01
    if (nearly(per1, 0.01)) pass("0.0最小0.01‰: boost"); else fail("0.0最小0.01‰: boost", per1);
    const per2 = computeZeroDotZeroWeight(990, 100); // remainder=10 → even=0.1 → keep=0.1
    if (nearly(per2, 0.1)) pass("0.0最小0.01‰: keep"); else fail("0.0最小0.01‰: keep", per2);

    // Test 6: 手入力→クラス照合
    const classes = [140, 145, 150];
    const idxA = (function(values, v){ for (let i=0;i<values.length;i++){ const cls=values[i]; if (v>=cls-0.9-1e-9 && v<=cls+1e-9) return i; } return -1; })(classes, 144.5);
    if (idxA === 1) pass("manual class match"); else fail("manual class match", idxA);

    // Test 7: 0.0セル数0のときの割当=0
    const per3 = computeZeroDotZeroWeight(500, 0);
    if (per3 === 0) pass("zero 0.0 cells => 0"); else fail("zero 0.0 cells => 0", per3);

    // Test 8: clampClassroomCount（1〜40に丸める）
    if (clampClassroomCount(0) === 1 && clampClassroomCount(41) === 40 && clampClassroomCount(16.9) === 16) {
      pass("clampClassroomCount bounds");
    } else {
      fail("clampClassroomCount bounds", `${clampClassroomCount(1)},${clampClassroomCount(21)},${clampClassroomCount(16.9)}`);
    }
  } catch (e) {
    console.error("テスト中に例外", e);
  } finally {
    const okAll = results.every(r => r.ok);
    const prefix = okAll ? "✅" : "❌";
    console.log(prefix + " 内部テスト結果:");
    results.forEach(r => {
      if (r.ok) console.log("  PASS:", r.name);
      else console.warn("  FAIL:", r.name, r.msg || "");
    });
  }
}


      // React 18 のマウント
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
